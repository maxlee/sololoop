#!/bin/bash
# ============================================================================
# SoloLoop Show Log Script - 显示决策日志
# ============================================================================
#
# 功能说明：
#   读取 decisions-log.md，格式化输出最近条目
#
# 使用方法：
#   /sololoop:show-log           # 显示最近 5 条
#   /sololoop:show-log 10        # 显示最近 10 条
#   /sololoop:show-log all       # 显示全部
#
# 参数说明：
#   COUNT   显示条目数量（可选，默认 5，或 "all" 显示全部）
#
# Requirements: 5.4
# ============================================================================

set -euo pipefail

# ----------------------------------------------------------------------------
# 配置
# ----------------------------------------------------------------------------
SOLOLOOP_DIR=".sololoop"
DECISIONS_LOG="$SOLOLOOP_DIR/decisions-log.md"
DEFAULT_COUNT=5

# ----------------------------------------------------------------------------
# 解析参数
# ----------------------------------------------------------------------------
COUNT_ARG="${1:-$DEFAULT_COUNT}"

# ----------------------------------------------------------------------------
# 检查目录是否存在
# ----------------------------------------------------------------------------
if [[ ! -d "$SOLOLOOP_DIR" ]]; then
  echo "❌ 错误：目标记忆目录不存在"
  echo ""
  echo "请先运行 /sololoop:init 或 /sololoop 初始化目标记忆"
  exit 1
fi

# ----------------------------------------------------------------------------
# 检查 decisions-log.md 是否存在
# ----------------------------------------------------------------------------
if [[ ! -f "$DECISIONS_LOG" ]]; then
  echo "ℹ️ 决策日志为空"
  echo ""
  echo "使用 /sololoop:log \"决策描述\" 添加记录"
  exit 0
fi

# ----------------------------------------------------------------------------
# 提取日志条目
# ----------------------------------------------------------------------------
# 日志格式：以 "## [" 开头的行是条目标题
# 使用 awk 提取条目

extract_entries() {
  awk '
    /^## \[/ {
      if (entry != "") {
        print entry
        print "---ENTRY_SEPARATOR---"
      }
      entry = $0
      next
    }
    /^---$/ {
      next
    }
    /^# Decision Log/ {
      next
    }
    /^记录执行过程中/ {
      next
    }
    /^每条记录格式/ {
      next
    }
    /^- 时间戳/ || /^- 决策摘要/ || /^- 理由/ {
      next
    }
    /^使用.*命令添加/ {
      next
    }
    entry != "" && NF > 0 {
      entry = entry "\n" $0
    }
    END {
      if (entry != "") {
        print entry
      }
    }
  ' "$DECISIONS_LOG"
}

# 获取所有条目
ENTRIES=$(extract_entries)

# 检查是否有条目
if [[ -z "$ENTRIES" ]] || [[ "$ENTRIES" == "---ENTRY_SEPARATOR---" ]]; then
  echo "ℹ️ 决策日志为空"
  echo ""
  echo "使用 /sololoop:log \"决策描述\" 添加记录"
  exit 0
fi

# ----------------------------------------------------------------------------
# 计算条目数量
# ----------------------------------------------------------------------------
TOTAL_ENTRIES=$(echo "$ENTRIES" | grep -c "^## \[" || echo "0")

# ----------------------------------------------------------------------------
# 输出标题
# ----------------------------------------------------------------------------
echo "📋 决策日志"
echo "==========="
echo ""

# ----------------------------------------------------------------------------
# 根据参数显示条目
# ----------------------------------------------------------------------------
if [[ "$COUNT_ARG" == "all" ]]; then
  SHOW_COUNT=$TOTAL_ENTRIES
  echo "显示全部 $TOTAL_ENTRIES 条记录："
else
  SHOW_COUNT=$COUNT_ARG
  if [[ $SHOW_COUNT -gt $TOTAL_ENTRIES ]]; then
    SHOW_COUNT=$TOTAL_ENTRIES
  fi
  echo "显示最近 $SHOW_COUNT 条记录（共 $TOTAL_ENTRIES 条）："
fi

echo ""

# 使用 tac 反转顺序（最新的在前），然后取前 N 条
# 由于 macOS 没有 tac，使用 tail -r
if command -v tac &> /dev/null; then
  REVERSE_CMD="tac"
else
  REVERSE_CMD="tail -r"
fi

# 分割条目并反转顺序，取前 N 条
echo "$ENTRIES" | \
  awk -v RS="---ENTRY_SEPARATOR---" -v ORS="\n---\n" 'NF {print}' | \
  $REVERSE_CMD | \
  head -n $((SHOW_COUNT * 3)) | \
  $REVERSE_CMD | \
  sed '/^$/d' | \
  head -n $((SHOW_COUNT * 4))

echo ""
echo "💡 使用 /sololoop:log \"描述\" 添加新记录"
