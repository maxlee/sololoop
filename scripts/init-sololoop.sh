#!/bin/bash
# ============================================================================
# SoloLoop Init Script - åˆå§‹åŒ–ç›®æ ‡è®°å¿†ç›®å½•ç»“æž„
# ============================================================================
#
# åŠŸèƒ½è¯´æ˜Žï¼š
#   åˆ›å»º .sololoop/ ç›®å½•ç»“æž„ï¼Œå¤åˆ¶æ¨¡æ¿æ–‡ä»¶ï¼Œæ”¯æŒä»Ž prompt æå–ç›®æ ‡ã€‚
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   /sololoop:init                    # æ‰‹åŠ¨åˆå§‹åŒ–ï¼ˆç©ºæ¨¡æ¿ï¼‰
#   /sololoop:init "ä»»åŠ¡æè¿°"          # ä»Ž prompt æå–ç›®æ ‡
#
# å‚æ•°è¯´æ˜Žï¼š
#   PROMPT        ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼Œç”¨äºŽæå–ç›®æ ‡ï¼‰
#
# Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7
# ============================================================================

set -euo pipefail

# ----------------------------------------------------------------------------
# é…ç½®
# ----------------------------------------------------------------------------
SOLOLOOP_DIR=".sololoop"
ARCHIVED_DIR="$SOLOLOOP_DIR/archived-goals"
PLUGIN_ROOT="${CLAUDE_PLUGIN_ROOT:-$(dirname "$(dirname "$0")")}"
TEMPLATES_DIR="$PLUGIN_ROOT/templates"

# ----------------------------------------------------------------------------
# è§£æžå‚æ•°
# ----------------------------------------------------------------------------
PROMPT="${*:-}"

# ----------------------------------------------------------------------------
# æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
# ----------------------------------------------------------------------------
if [[ -d "$SOLOLOOP_DIR" ]]; then
  echo "â„¹ï¸ ç›®æ ‡è®°å¿†ç›®å½•å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
  echo ""
  echo "çŽ°æœ‰æ–‡ä»¶ï¼š"
  ls -la "$SOLOLOOP_DIR/" 2>/dev/null || true
  echo ""
  echo "å¦‚éœ€é‡æ–°åˆå§‹åŒ–ï¼Œè¯·å…ˆåˆ é™¤ $SOLOLOOP_DIR ç›®å½•"
  exit 0
fi

# ----------------------------------------------------------------------------
# åˆ›å»ºç›®å½•ç»“æž„
# ----------------------------------------------------------------------------
echo "ðŸŽ¯ åˆå§‹åŒ– SoloLoop ç›®æ ‡è®°å¿†..."
echo ""

mkdir -p "$SOLOLOOP_DIR"
mkdir -p "$ARCHIVED_DIR"

# ----------------------------------------------------------------------------
# å¤åˆ¶æ¨¡æ¿æ–‡ä»¶
# ----------------------------------------------------------------------------
if [[ -f "$TEMPLATES_DIR/goal.md" ]]; then
  cp "$TEMPLATES_DIR/goal.md" "$SOLOLOOP_DIR/goal.md"
else
  # å†…è”æ¨¡æ¿ä½œä¸ºåŽå¤‡
  cat > "$SOLOLOOP_DIR/goal.md" << 'EOF'
# Current Goal

## Summary

[ä»Žç”¨æˆ· prompt è‡ªåŠ¨æå–æˆ–æ‰‹åŠ¨å¡«å†™çš„ç›®æ ‡æ‘˜è¦]

## Success Criteria

- [ ] æ¡ä»¶ 1: [æè¿°æˆåŠŸçš„å…·ä½“æ ‡å‡†]
- [ ] æ¡ä»¶ 2: [æè¿°æˆåŠŸçš„å…·ä½“æ ‡å‡†]

## Scope Boundaries

### åŒ…å« (In Scope)

- [æ˜Žç¡®åŒ…å«åœ¨æœ¬æ¬¡ç›®æ ‡èŒƒå›´å†…çš„å†…å®¹]

### ä¸åŒ…å« (Out of Scope)

- [æ˜Žç¡®ä¸åœ¨æœ¬æ¬¡ç›®æ ‡èŒƒå›´å†…çš„å†…å®¹]
EOF
fi

if [[ -f "$TEMPLATES_DIR/invariants.md" ]]; then
  cp "$TEMPLATES_DIR/invariants.md" "$SOLOLOOP_DIR/invariants.md"
else
  cat > "$SOLOLOOP_DIR/invariants.md" << 'EOF'
# Core Invariants

æ ¸å¿ƒçº¦æŸæ¸…å• - è¿™äº›æ˜¯ä¸å¯å¦¥åçš„åº•çº¿è¦æ±‚ã€‚

## Must Have

- [å…³é”®çº¦æŸ 1]
- [å…³é”®çº¦æŸ 2]

## Must Not

- [ç¦æ­¢äº‹é¡¹ 1]
- [ç¦æ­¢äº‹é¡¹ 2]

## Performance Constraints

- [æ€§èƒ½è¦æ±‚ 1]
EOF
fi

if [[ -f "$TEMPLATES_DIR/decisions-log.md" ]]; then
  cp "$TEMPLATES_DIR/decisions-log.md" "$SOLOLOOP_DIR/decisions-log.md"
else
  cat > "$SOLOLOOP_DIR/decisions-log.md" << 'EOF'
# Decision Log

è®°å½•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é‡è¦å†³ç­–å’Œç›®æ ‡è°ƒæ•´ã€‚

---
EOF
fi

# ----------------------------------------------------------------------------
# ä»Ž prompt æå–ç›®æ ‡ï¼ˆå¦‚æžœæä¾›ï¼‰
# ----------------------------------------------------------------------------
if [[ -n "$PROMPT" ]]; then
  # å°† prompt å†™å…¥ goal.md çš„ Summary éƒ¨åˆ†
  cat > "$SOLOLOOP_DIR/goal.md" << EOF
# Current Goal

## Summary

$PROMPT

## Success Criteria

- [ ] å®Œæˆä¸Šè¿°ç›®æ ‡æè¿°çš„ä»»åŠ¡
- [ ] é€šè¿‡æ‰€æœ‰ç›¸å…³æµ‹è¯•
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ

## Scope Boundaries

### åŒ…å« (In Scope)

- ä¸Šè¿°ç›®æ ‡æè¿°ä¸­æ˜Žç¡®æåˆ°çš„åŠŸèƒ½

### ä¸åŒ…å« (Out of Scope)

- æœªåœ¨ç›®æ ‡ä¸­æ˜Žç¡®æåˆ°çš„åŠŸèƒ½æ‰©å±•
- æ€§èƒ½ä¼˜åŒ–ï¼ˆé™¤éžæ˜Žç¡®è¦æ±‚ï¼‰
EOF
  echo "âœ… å·²ä»Ž prompt æå–ç›®æ ‡åˆ° goal.md"
fi

# ----------------------------------------------------------------------------
# è¾“å‡ºç»“æžœ
# ----------------------------------------------------------------------------
echo "âœ… ç›®æ ‡è®°å¿†åˆå§‹åŒ–å®Œæˆï¼"
echo ""
echo "ðŸ“ åˆ›å»ºçš„ç›®å½•ç»“æž„ï¼š"
echo "  $SOLOLOOP_DIR/"
echo "  â”œâ”€â”€ goal.md           # å½“å‰ç›®æ ‡æè¿°"
echo "  â”œâ”€â”€ invariants.md     # æ ¸å¿ƒçº¦æŸæ¸…å•"
echo "  â”œâ”€â”€ decisions-log.md  # å†³ç­–åŽ†å²è®°å½•"
echo "  â””â”€â”€ archived-goals/   # åŽ†å²ç›®æ ‡å­˜æ¡£"
echo ""
if [[ -z "$PROMPT" ]]; then
  echo "ðŸ’¡ æç¤ºï¼šè¯·ç¼–è¾‘ goal.md å’Œ invariants.md è®¾ç½®ä½ çš„ç›®æ ‡å’Œçº¦æŸ"
else
  echo "ðŸ’¡ æç¤ºï¼šç›®æ ‡å·²ä»Ž prompt æå–ï¼Œå¯ç¼–è¾‘ goal.md è¿›è¡Œç»†åŒ–"
fi
echo ""
echo "ç›®æ ‡è®°å¿†å°†åœ¨åŽç»­ sololoop æ‰§è¡Œä¸­è‡ªåŠ¨æ¿€æ´»ã€‚"
