#!/bin/bash
# ============================================================================
# SoloLoop Log Decision Script - è®°å½•å†³ç­–åˆ° decisions-log.md
# ============================================================================
#
# åŠŸèƒ½è¯´æ˜Žï¼š
#   æŽ¥æ”¶å†³ç­–æè¿°å‚æ•°ï¼Œç”Ÿæˆ ISO 8601 æ—¶é—´æˆ³ï¼Œè¿½åŠ æ ¼å¼åŒ–æ¡ç›®åˆ° decisions-log.md
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   /sololoop:log "å†³ç­–æè¿°"
#
# å‚æ•°è¯´æ˜Žï¼š
#   DECISION_TEXT   å†³ç­–æè¿°æ–‡æœ¬ï¼ˆå¿…éœ€ï¼‰
#
# Requirements: 5.2, 5.3
# ============================================================================

set -euo pipefail

# ----------------------------------------------------------------------------
# é…ç½®
# ----------------------------------------------------------------------------
SOLOLOOP_DIR=".sololoop"
DECISIONS_LOG="$SOLOLOOP_DIR/decisions-log.md"

# ----------------------------------------------------------------------------
# è§£æžå‚æ•°
# ----------------------------------------------------------------------------
DECISION_TEXT="${*:-}"

# ----------------------------------------------------------------------------
# å‚æ•°éªŒè¯
# ----------------------------------------------------------------------------
if [[ -z "$DECISION_TEXT" ]]; then
  echo "âŒ é”™è¯¯ï¼šè¯·æä¾›å†³ç­–æè¿°"
  echo ""
  echo "ä½¿ç”¨æ–¹æ³•ï¼š"
  echo "  /sololoop:log \"å†³ç­–æè¿°\""
  echo ""
  echo "ç¤ºä¾‹ï¼š"
  echo "  /sololoop:log \"å†³å®šä½¿ç”¨æ–¹æ¡ˆ A è€Œéžæ–¹æ¡ˆ Bï¼Œå› ä¸ºæ€§èƒ½æ›´å¥½\""
  exit 1
fi

# ----------------------------------------------------------------------------
# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
# ----------------------------------------------------------------------------
if [[ ! -d "$SOLOLOOP_DIR" ]]; then
  echo "âŒ é”™è¯¯ï¼šç›®æ ‡è®°å¿†ç›®å½•ä¸å­˜åœ¨"
  echo ""
  echo "è¯·å…ˆè¿è¡Œ /sololoop:init æˆ– /sololoop åˆå§‹åŒ–ç›®æ ‡è®°å¿†"
  exit 1
fi

# ----------------------------------------------------------------------------
# æ£€æŸ¥ decisions-log.md æ˜¯å¦å­˜åœ¨
# ----------------------------------------------------------------------------
if [[ ! -f "$DECISIONS_LOG" ]]; then
  echo "âš ï¸ decisions-log.md ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
  cat > "$DECISIONS_LOG" << 'EOF'
# Decision Log

è®°å½•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é‡è¦å†³ç­–å’Œç›®æ ‡è°ƒæ•´ã€‚

---
EOF
fi

# ----------------------------------------------------------------------------
# ç”Ÿæˆ ISO 8601 æ—¶é—´æˆ³
# ----------------------------------------------------------------------------
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
DISPLAY_TIME=$(date +"%Y-%m-%d %H:%M:%S")

# ----------------------------------------------------------------------------
# è¿½åŠ å†³ç­–æ¡ç›®
# ----------------------------------------------------------------------------
cat >> "$DECISIONS_LOG" << EOF

## [$DISPLAY_TIME]

$DECISION_TEXT

---
EOF

# ----------------------------------------------------------------------------
# è¾“å‡ºç¡®è®¤ä¿¡æ¯
# ----------------------------------------------------------------------------
echo "âœ… å†³ç­–å·²è®°å½•"
echo ""
echo "ðŸ“ æ—¶é—´æˆ³: $DISPLAY_TIME"
echo "ðŸ“„ å†…å®¹: $DECISION_TEXT"
echo ""
echo "æŸ¥çœ‹å®Œæ•´æ—¥å¿—: /sololoop:show-log"
